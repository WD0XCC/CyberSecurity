## 1、横向移动概述

### 1.1 横向移动目的和危害

**1）目的**

攻击者利用该技术，以被攻陷的系统为跳板，访问其他域内主机，扩大资产范围，包括跳板机中的文档和存储的凭证、以及通过跳板机器连接的数据库、域控制器或其他重要的资产

**2）危害**

通过此类手段，攻击者最终可能获取域控制器的访问权限、甚至完全控制基于Windows操作系统的基础设施和业务相关的关键账户。

### 1.2 远程连接Windows方法

拿到目标计算机的用户明文密码或者NTLM Hash后，可以通过PTH（Pass The Hash，凭据传递）的方法。将散列值或者明文密码传送到目标机器中进行验证。与目标机器建立连接后，可以使用相关的方法在远程Windows操作系统中执行命令。

#### 1.2.1 使用IPC连接

**1）作用**

通过$ipc可以和目标机器建立连接。利用这个连接，不仅可以访问目标机器中的文件，进行上传、下载等操作，还可以在目标机器上运行其他命令，以获得目标机器的目录结构、用户列表信息。**

**2）IPC利用条件**

* 开启了139、445端口：139表示开启NetBIOS协议的应用、通过139、445可以实现对共享文件/打印机的访问。
* 管理员开启了默认共享：默认开启、通过$ipc可以实现对包括逻辑磁盘（如C$、D$、E$等）在内的默认共享目录的访问。

**3）ipc的使用步骤**

* 建立连接： net use \\192.168.0.100\ipc$ "password" /user:"administrator"

* 执行操作：

  * 上传文件：copy putty.exe \\\192.168.0.100\\admin$

    admin$表示C:\\WINDOWS\\目录

  * 查看对方电脑时间：net time \\\192.168.0.100

  * 定时运行程序：at \\\192.168.0.100 19:45 putty.exe

  * 确认是否启动：

  * 映射远程磁盘到本地：net use Z: \\\192.168.0.100\\c$

* 删除/断开IPC连接： net use \\192.168.0.100 /del

  

#### 1.2.2 windows自带的工具

**1）Dir命令**

使用net use建立ipc连接后，可以使用dir命令列出远程主机中的文件。

**2）tasklist命令**

使用net use建立ipc连接后，可以使用tasklist命令的 /S、/U、/P等参数列出目标机器上的运行的进程。

#### 1.2.3 计划任务

**1）at命令**

适用于Server 2008以前。

**2）schtasks命令**

## 2、Windows密码散列

1）Windows密码存储位置



2）Windows身份认证方式



3）



## 3、横向移动技术分析

### 3.1 利用Windows远程连接命令进行横向渗透

#### 3.1.1 IPC方式

### 3.2 利用Windows计划任务进行横向渗透

#### 3.2.1 利用at命令

#### 3.2.2 利用schtasks命令

### 3.3 创建Windows服务来进行横向渗透

#### 3.3.1 利用 sc 命令

### 3.4 利用PsExec工具进行横向渗透

### 3.5 利用WMI来横向渗透

### 3.6 利用WMIEXEC来横向移动

WMI的全名为“Windows Management Instrumentation”。从Windows 98开始，Windows操作系统都支持WMI。WMI是由一系列工具集组成的，可以通过/node选项使用端口135上的远程过程调用(RPC)进行通信以进行远程访问，它允许系统管理员远程执行自动化管理任务，例如远程启动服务或执行命令。

注意：**使用WMIC连接远程主机，需要目标主机开放135和445端口。(135 端⼝是 WMIC 默认的管理端⼝，而 wimcexec 使⽤445端⼝传回显)**

### 3.7 利用DCOM在远程机器中执行命令

### 3.8 哈希传递攻击

##### 1）使用Mimikatz进行PTH

前提：已经拿到win7系统权限，否则不能执行mimikatz。

**1、抓取跳板机器Hash**

**2、添加Administrator账号Hash到lsass进程中**

**3、在新shell中执行操作**

##### 2）使用Metasploit进行PTH

##### 3)利用wmiexec.py进行PTH

### 3.9 票据传递攻击

PTT攻击的优势：PTH攻击需要获取目标机器的管理员权限， 而PTT攻击不需要管理员权限。

在票据传递攻击中，最常用的有**MS14-068、黄金票据、白银票据**。其中MS14-068可用来横向获取域内主机权限，黄金票据、白银票据则可以用来对域控进行权限维持。

PTH（Pass The Hash,哈希传递）是基于NTLM认证的。而票据传递（Pass The Ticket, PTT）是基于Kerberos协议认证的。

#### 3.9.1 MS14-068

#### 3.9.2 黄金票据

#### 3.9.3 白银票据

### 3.10 利用NTLM Relay攻击